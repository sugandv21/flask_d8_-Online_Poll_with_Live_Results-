<!DOCTYPE html>
<html lang="en">
<head>
    <title>Online Poll</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let chart;

        function fetchPoll() {
            fetch("/api/poll")
                .then(response => response.json())
                .then(data => updateChart(data.options));
        }

        function vote(option) {
            fetch("/api/vote", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ option: option })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, "danger");
                } else {
                    showAlert(data.message, "success");
                    updateChart(data.results);
                }
            });
        }

        function updateChart(results) {
            let labels = Object.keys(results);
            let values = Object.values(results);

            if (!chart) {
                let ctx = document.getElementById("pollChart").getContext("2d");
                chart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Votes",
                            data: values,
                            backgroundColor: ["#0d6efd", "#198754", "#ffc107", "#dc3545"]
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            } else {
                chart.data.datasets[0].data = values;
                chart.update();
            }
        }

        function showAlert(message, type) {
            let alertBox = document.getElementById("alert-box");
            alertBox.innerHTML = `
              <div class="alert alert-${type} alert-dismissible fade show mt-3" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>`;
        }

        setInterval(fetchPoll, 5000); 
        window.onload = fetchPoll;
    </script>
</head>
<body class="container mt-5">
    <h2 class="text-center"> Online Poll</h2>
    <h4 class="text-center">{{ poll.question }}</h4>

    <div class="text-center mt-4">
        {% for option in poll.options.keys() %}
            <button class="btn btn-primary m-2" onclick="vote('{{ option }}')">Vote {{ option }}</button>
        {% endfor %}
    </div>

    <div id="alert-box"></div>

    <div class="card shadow-lg mx-auto mt-4 p-3" style="max-width: 600px;">
        <canvas id="pollChart"></canvas>
    </div>
</body>
</html>
